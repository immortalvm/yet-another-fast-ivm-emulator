# Yet another (fast) IVM emulator

This ivm64 emulator takes an ivm64 binary and emulates its execution. It benefits from two kind of optimizations:

  * Optimized execution of common instruction patterns generated by the c compiler
  * Parallel threaded execution for output instructions

### How to compile?

```
    make # generates the next three executables
    gcc -Ofast            ivm_emu.c # The fastest one without input/ouput but put_char
    gcc -Ofast -DWITH_IO  ivm_emu.c ivm_io.c -lpng  # Enable IO instructions
    gcc -Ofast -DWITH_IO  ivm_emu.c ivm_io.c io_handler.c list.c -lpng -DPARALLEL_OUTPUT -pthread # Parallel IO

    # the following options are for debugging and they can make the execution slower:
    gcc -Ofast -DNOOPT     ivm_emu.c  # Disable optimizations
    gcc -Ofast -DVERBOSE=1 ivm_emu.c  # Enable verbose
    gcc -Ofast -DVERBOSE=2 ivm_emu.c  # Trace mode
    gcc -Ofast -DVERBOSE=3 ivm_emu.c  # Detailed trace mode
    gcc -Ofast -DSTEPCOUNT ivm_emu.c  # Enable instruction count
    gcc -Ofast -DHISTOGRAM ivm_emu.c  # Enable insn. pattern histogram

     Number of threads for the version with parallel output:
     * Default: 8
     * if compiled with -DNUM_THREADS=N1, N1 is used instead of the default value
     * if environment variable export NUM_THREADS=N2, N2 is used instead of N1 or default
     * In any case, the parallel version uses at least 2 threads, in general:
                1 thread for emulation and (N-1) thread for io

```

### How to execute?

Options keep compatibility with the original ivm implementation. 

```ivm_emu_fast [-m <size in bytes>] [-a <arg file>] [-i <input dir>] [-o <output dir>] <ivm_binary_file> ```

### Execution times

These experiments were conducted on an Intel(R) Xeon(R) Gold 6154 CPU @ 3.00GHz, where the emulator was compiled with gcc 7.4.0.

Code static_unboxing was compiled with gcc 8.3.0-ivm64-1.0-rc3. This code has no I/O instructions but ```put_char```.

Code ex4_short_video.s is one of the example codes provided with the ivm application.

Binaries generated with ivm v0.28. 

| benchmark                      | no optimization | optimized |  optimized +  parallel io |
|--------------------------------|-----------------|-----------|---------------------------| 
| static_unboxing                |4m50s            | 1m45s     |               |
| ex4_short_video.s (512 frames) |3m59s            | 2m97s     |  0.93s        |








